---
title: "Population structure: PCA analysis and Admixture"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.retina = 2)
library(tidyverse)
library(ggpubr)
library(ggtree)
library(phytools)
library(ggrepel)
source("scripts/my_color.R")
```


### PCAngsd analysis

We firstly used pcangsd to calculate covariance of all SNPs and plotted the first two principles. The strongest variance was observed between samples from MI and all the other north reefs. The samples from north reefs seems form a big cluster without any clustering pattern with only internal genetic diversity reflected along PC2. We also identified 4 potential hybrids, consistently in PCA plot and Admixture plot. These hybrids were excluded in selection analysis, IBS tree, and demographic modelling.

```bash
pcangsd --beagle atenuis.beagle.gz --threads 48 --admix --admix_auto 10000 --out atenuis.pcangsd
```

```{r, fig.width=9.2, fig.height=3.8}
covmat <- read_table("data/hpc/pca/atenius.ind212.unique_mdust1M.pcangsd.cov",col_names = F) %>% as.matrix()

sample_ids <- read_tsv("data/hpc/pca/ind212.txt", col_names = "sample_id",show_col_types = FALSE) %>% pull(sample_id)

colnames(covmat)<- sample_ids
rownames(covmat) <- sample_ids

pop_eigen <- eigen(covmat)
sample_table <- read_csv("data/hpc/qc/summary_data.csv",show_col_types = FALSE) %>% select(sample_id,pop,location,reef) %>% mutate(reef=ifelse(reef=="Outer","Offshore","Inshore"))

pop_pca12 <- data.frame(x=pop_eigen$vectors[,1],y=pop_eigen$vectors[,2],sample_id = sample_ids) %>% left_join(sample_table) %>% mutate(pop_order=site_order()[pop])
pop_pca23 <- data.frame(x=pop_eigen$vectors[,2],y=pop_eigen$vectors[,3],sample_id = sample_ids) %>% left_join(sample_table) %>% mutate(pop_order=site_order()[pop])
pc1 <- round(((pop_eigen$values)/sum(pop_eigen$values))*100,2)[1]
pc2 <- round(((pop_eigen$values)/sum(pop_eigen$values))*100,2)[2]
pc3 <- round(((pop_eigen$values)/sum(pop_eigen$values))*100,2)[3]

p1<-ggplot(pop_pca12, aes(x=x,y=y)) + geom_point(aes(color=reorder(pop,pop_order),shape=reef),size=2)+ 
  geom_text_repel(data=pop_pca12 %>% filter(sample_id %in% c("MI-1-1_S10","PI-1-16_S16","DI-2-4_S17","ARL_15_S69")),aes(x=x,y=y,label=sample_id),size=2,hjust=2,vjust=1) + 
  geom_point(data=pop_pca12 %>% filter(sample_id %in% c("MI-1-1_S10","PI-1-16_S16","DI-2-4_S17","ARL_15_S69")),aes(x=x,y=y),size=.8,color="black") +
  scale_color_manual(values = site_colors(), labels=site_labels(),guide="none") + 
  theme_test(base_size = 12) + labs(x=paste0("PC1 (",pc1,"%)"),y=paste0("PC2 (",pc2,"%)")) + theme(legend.position = "none")

p2<-ggplot(pop_pca23, aes(x=x,y=y)) + geom_point(aes(color=reorder(pop,pop_order),shape=reef),size=2)+
  scale_color_manual(values = site_colors(), labels=site_labels()) + 
  theme_test(base_size = 12) + labs(x=paste0("PC2 (",pc2,"%)"),y=paste0("PC3 (",pc3,"%)"), shape="Location", color="Reef")

cowplot::plot_grid(p1,p2,rel_widths = c(0.42,0.58), labels = c("a)","b)"),label_size = 12)

#ggsave("s-fig-pca.png",width = 9.2,height = 3.8)

hybrids <-c("MI-1-1_S10","PI-1-16_S16","DI-2-4_S17","ARL_15_S69")
```

**The admixture plot based on PCAngsd**

```{r}
q2_admixture <- read_table("data/hpc/pca/atenius.ind212.unique_mdust1M.pcangsd.admix.2.Q", col_names = c("X2","X1")) %>%
  add_column(sample_id = sample_ids) %>% 
  gather(cluster, proportion, -sample_id) %>% 
  left_join(sample_table) %>% 
  mutate(pop_order = site_order()[pop])

p1 <- ggplot(q2_admixture ,aes(x=reorder(sample_id,pop_order),y=proportion)) + 
  geom_bar(aes(fill=cluster,color=cluster),stat="identity") + 
  geom_point(data=q2_admixture %>% filter(sample_id %in% hybrids),aes(x=reorder(sample_id,pop_order)),y=1,shape=8) + 
  facet_grid(reorder(location,desc(pop_order))~., scales = "free_y") + coord_flip() + theme_pubclean() + labs(x="",y="Proportion (K=2)") + 
  scale_fill_brewer(palette = "Set2") + 
  scale_color_brewer(palette = "Set2") + 
  theme_minimal() +
  theme(axis.text.y = element_blank(),
        legend.position = "none", 
        axis.ticks = element_blank(),
        panel.border = element_blank(), 
        panel.background = element_blank(),
        panel.grid = element_blank(),
        strip.text.y = element_text(size=12,angle = 0,hjust=-0.1))
p1
```


### LD-Pruned results

We did the same PCA analysis with PCAngsd with LD-pruned SNPs.

```{r fig.width=9.2, fig.height=3.8}
covmat_unlinked <- read_table("data/hpc/pca/atenius.ld_pruned_snps.pcangsd.cov",col_names = F) %>% as.matrix()

colnames(covmat_unlinked)<- sample_ids
rownames(covmat_unlinked) <- sample_ids

pop_eigen_unlinked <- eigen(covmat_unlinked)

pop_pca12_unlinked <- data.frame(x=pop_eigen_unlinked$vectors[,1],y=pop_eigen_unlinked$vectors[,2],sample_id = sample_ids) %>% left_join(sample_table) %>% mutate(pop_order=site_order()[pop])
pop_pca23_unlinked <- data.frame(x=pop_eigen_unlinked$vectors[,2],y=pop_eigen_unlinked$vectors[,3],sample_id = sample_ids) %>% left_join(sample_table) %>% mutate(pop_order=site_order()[pop])
pc1 <- round(((pop_eigen_unlinked$values)/sum(pop_eigen$values))*100,2)[1]
pc2 <- round(((pop_eigen_unlinked$values)/sum(pop_eigen$values))*100,2)[2]
pc3 <- round(((pop_eigen_unlinked$values)/sum(pop_eigen$values))*100,2)[3]

p1<-ggplot(pop_pca12_unlinked, aes(x=x,y=y)) + geom_point(aes(color=reorder(pop,pop_order),shape=reef),size=2)+
  scale_color_manual(values = site_colors(), labels=site_labels()) + 
  theme_test() + labs(x=paste0("PC1 (",pc1,"%)"),y=paste0("PC2 (",pc2,"%)"))+ theme(legend.position = "none")

p2<-ggplot(pop_pca23_unlinked, aes(x=x,y=y)) + geom_point(aes(color=reorder(pop,pop_order),shape=reef),size=2)+
  scale_color_manual(values = site_colors(), labels=site_labels()) + 
  theme_test() + labs(x=paste0("PC2 (",pc2,"%)"),y=paste0("PC3 (",pc3,"%)"), shape="Location", color="Reef")

cowplot::plot_grid(p1,p2,rel_widths = c(0.42,0.58), labels = c("a)","b)"),label_size = 12)
```

In this PCA plot, A minor discontinuity was in north reefs samples were observed but the results were qualitatively the same.


```{r}
q2_admixture_unlinked <- read_table("data/hpc/pca/atenius.ld_pruned_snps.pcangsd.admix.2.Q", col_names = c("X2","X1")) %>%
  add_column(sample_id = sample_ids) %>% 
  gather(cluster, proportion, -sample_id) %>% 
  left_join(sample_table) %>% 
  mutate(pop_order = site_order()[pop])

p1 <- ggplot(q2_admixture_unlinked ,aes(x=reorder(sample_id,pop_order),y=proportion)) + 
  geom_bar(aes(fill=cluster,color=cluster),stat="identity") + 
  facet_grid(reorder(location,desc(pop_order))~., scales = "free") + coord_flip() + theme_pubclean() + labs(x="",y="Proportion (K=2)") + 
  scale_fill_brewer(palette = "Set2") + 
  scale_color_brewer(palette = "Set2") + 
  theme_minimal() +
  theme(axis.text.y = element_blank(),
        legend.position = "none", 
        axis.ticks = element_blank(),
        panel.border = element_blank(), 
        panel.background = element_blank(),
        panel.grid = element_blank(),
        strip.text.y  = element_text(size=12,angle =0,hjust = -0.1))
p1
```

### Admixture analysis

The individual admixture proportion was also inferred by `NGSAdmix` with K set to 2 and 3.

```bash
NGSadmix -likes atenius.ind212.unique_mdust1M.beagle.gz -K 2 -outfiles atenius.ind212.unique_mdust1M.K2 -P 20 -minMaf 0.05 -minInd 100
NGSadmix -likes atenius.ind212.unique_mdust1M.beagle.gz -K 3 -outfiles atenius.ind212.unique_mdust1M.K3 -P 20 -minMaf 0.05 -minInd 100

NGSadmix -likes atenius.ld_pruned_snps.beagle.gz -K 2 -outfiles atenius.ld_pruned_snps.K2 -P 20 -minMaf 0.05 -minInd 100
NGSadmix -likes atenius.ld_pruned_snps.beagle.gz -K 3 -outfiles atenius.ld_pruned_snps.K3 -P 20 -minMaf 0.05 -minInd 100
```
The results from all snps were presented here.

```{r, fig.width=9.8,fig.height=4}
qopt2 <- read_table("data/hpc/ngsAdmix/atenius.ind212.unique_mdust1M.K2.qopt",col_names = c("X1","X2")) %>% 
  add_column(sample_id = sample_ids) %>% gather(cluster, proportion, -sample_id) %>% left_join(sample_table) %>% mutate(pop_order = site_order()[pop])
qopt3 <- read_table("data/hpc/ngsAdmix/atenius.ind212.unique_mdust1M.K3.qopt",col_names = c("X1","X2","X3")) %>%
  add_column(sample_id = sample_ids) %>% gather(cluster, proportion, -sample_id) %>% left_join(sample_table) %>% mutate(pop_order = site_order()[pop])


p1<- ggplot(qopt2,aes(x=sample_id,y=proportion,fill=cluster)) + scale_fill_manual(values = c("white","black"),guide="none")+
  geom_col(color="darkgrey",size=0.1) +
  facet_grid(~reorder(location,pop_order), switch = "x",scales = "free",space = "free",labeller = label_wrap_gen(width = 12, multi_line = TRUE)) + 
  theme_minimal() + scale_y_continuous(expand = c(0,0)) +
  scale_x_discrete(expand = expand_scale(add=1))+
  labs(x = "", title = "K=2", y = "Ancestry")+
  #scale_y_reverse(labels = c("0","0.25","0.5","0.75","1"),expand=c(0,0)) +
  theme(panel.spacing.x = unit(0.1,"lines"),
        axis.text.x = element_blank(),
        panel.grid = element_blank(),
        strip.text.x = element_blank())
        #axis.text.y = element_text(angle=270,hjust = 0.5),
        #xis.title.y = element_text(angle = 270))

#ggsave("ngsAdmix.png",width = 6.3,height = 1.6)

p2<-ggplot(qopt3,aes(x=reorder(sample_id,pop_order),y=proportion,fill=cluster)) + #scale_fill_manual(values = c("black","lightgrey"))+
  geom_col(color="white",size=0.1) +
  facet_grid(~reorder(location,pop_order), switch = "x",scales = "free",space = "free",labeller = label_wrap_gen(width = 12, multi_line = TRUE)) + 
  theme_minimal() + scale_y_continuous(expand = c(0,0)) +
  scale_x_discrete(expand = expand_scale(add=1))+
  scale_fill_brewer(palette = "Set2") +
  labs(x = "Individuals", title = "K=3", y = "Ancestry")+
  theme(panel.spacing.x = unit(0.1,"lines"),
        axis.text.x = element_blank(),
        panel.grid = element_blank(),
        legend.position = "none")

cowplot::plot_grid(p1,p2,nrow=2,rel_heights = c(0.46,0.54))
#ggsave("s-fig-admix.png",width = 9.6,height = 4)

```
